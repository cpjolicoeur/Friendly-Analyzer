<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MFL Friendly Match Analyzer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #334155 0%, #475569 50%, #334155 100%);
      background-attachment: fixed;
      color: #f1f5f9;
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
      zoom: 0.75;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
      background-size: 50px 50px, 80px 80px;
      pointer-events: none;
      z-index: 1;
      opacity: 0.6;
    }

    .header, .controls, .status-container, .overview-section, .matches-section, .footer, .modal {
      position: relative;
      z-index: 2;
      transform: translateZ(0);
    }

    .header {
      max-width: 2200px;
      margin: 0 auto 30px;
      text-align: center;
      padding: 30px 20px;
      background: rgba(30, 41, 59, 0.85);
      border-radius: 16px;
      border: 1px solid rgba(238, 255, 0, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .header h1 {
      font-size: 42px;
      font-weight: 800;
      background: linear-gradient(135deg, #eeff00 0%, #fff76b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .header p {
      color: #cbd5e1;
      font-size: 16px;
      font-weight: 400;
    }

    .controls {
      max-width: 2200px;
      margin: 0 auto 30px;
      background: rgba(30, 41, 59, 0.85);
      padding: 30px;
      border-radius: 16px;
      border: 1px solid rgba(238, 255, 0, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .input-group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .input-group input {
      flex: 1;
      min-width: 200px;
      padding: 14px 18px;
      border: 1px solid rgba(238, 255, 0, 0.2);
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.5);
      color: #f1f5f9;
      font-size: 15px;
      transition: all 0.2s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #eeff00;
      box-shadow: 0 0 0 3px rgba(238, 255, 0, 0.1);
    }

    .input-group input::placeholder {
      color: #64748b;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #eeff00 0%, #c9d900 100%);
      color: #0f172a;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(238, 255, 0, 0.25);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: rgba(71, 85, 105, 0.8);
      color: #f1f5f9;
      border: 1px solid rgba(238, 255, 0, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(71, 85, 105, 1);
      border-color: #eeff00;
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.8);
      color: #fff;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 1);
    }

    .btn-export {
      background: rgba(34, 197, 94, 0.8);
      color: #fff;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .btn-export:hover {
      background: rgba(34, 197, 94, 1);
    }

    .status-container {
      max-width: 2200px;
      margin: 0 auto 30px;
      min-height: 50px;
    }

    .status {
      padding: 16px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      display: none;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease-out;
    }

    .status.show {
      display: flex;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .status.loading {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .overview-section, .matches-section {
      max-width: 2200px;
      margin: 0 auto 30px;
      display: none;
    }

    .overview-section.visible, .matches-section.visible {
      display: block;
    }

    .section-card {
      background: rgba(30, 41, 59, 0.85);
      padding: 30px;
      border-radius: 16px;
      border: 1px solid rgba(238, 255, 0, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: #eeff00;
      margin-bottom: 8px;
    }

    .section-subtitle {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
    }

    .stat-item {
      background: rgba(15, 23, 42, 0.5);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(238, 255, 0, 0.1);
      transition: all 0.2s;
    }

    .stat-item:hover {
      border-color: rgba(238, 255, 0, 0.3);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: #eeff00;
    }

    .xi-summary {
      margin-top: 20px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(238, 255, 0, 0.1);
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .xi-summary span {
      color: #cbd5e1;
      font-size: 14px;
    }

    .xi-summary strong {
      color: #eeff00;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(71, 85, 105, 0.4);
      font-size: 14px;
    }

    th {
      background: rgba(15, 23, 42, 0.7);
      color: #eeff00;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      user-select: none;
    }

    th:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    td {
      color: #cbd5e1;
    }

    tr:hover td {
      background: rgba(15, 23, 42, 0.3);
    }

    .sort-indicator {
      margin-left: 6px;
      font-size: 10px;
      color: #eeff00;
    }

    .match-item {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(238, 255, 0, 0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.2s;
    }

    .match-item:hover {
      border-color: rgba(238, 255, 0, 0.3);
      transform: translateY(-2px);
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .match-title {
      font-size: 20px;
      font-weight: 700;
      color: #eeff00;
    }

    .match-date {
      font-size: 14px;
      color: #94a3b8;
    }

    .match-score {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .team-name {
      font-size: 18px;
      font-weight: 600;
      color: #cbd5e1;
      min-width: 120px;
    }

    .score {
      color: #eeff00;
      font-size: 36px;
    }

    .match-stats {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .team-stats {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #cbd5e1;
    }

    .stat-row .label {
      color: #94a3b8;
      font-weight: 500;
    }

    .stat-divider {
      width: 1px;
      background: rgba(238, 255, 0, 0.1);
    }

    .footer {
      max-width: 2200px;
      margin: 40px auto 20px;
      text-align: center;
      color: #64748b;
      font-size: 14px;
    }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #93c5fd;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hide-row-btn {
      background: rgba(239, 68, 68, 0.6);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .hide-row-btn:hover {
      background: rgba(239, 68, 68, 1);
    }

    .hide-col-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 14px;
      padding: 0 4px;
      transition: color 0.2s;
    }

    .hide-col-btn:hover {
      color: #ef4444;
    }

    th.hidden-col, td.hidden-col {
      display: none;
    }

    .restore-btn-container {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 41, 59, 0.98);
      border: 1px solid rgba(238, 255, 0, 0.2);
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #eeff00;
    }

    .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .modal-body {
      color: #cbd5e1;
    }

    .saved-analysis-item {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(238, 255, 0, 0.1);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .saved-analysis-item:hover {
      border-color: rgba(238, 255, 0, 0.3);
    }

    .saved-analysis-info {
      flex: 1;
    }

    .saved-analysis-name {
      font-size: 16px;
      font-weight: 600;
      color: #eeff00;
      margin-bottom: 4px;
    }

    .saved-analysis-meta {
      font-size: 13px;
      color: #94a3b8;
    }

    .saved-analysis-actions {
      display: flex;
      gap: 8px;
    }

    .comparison-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .comparison-view {
      max-width: 2200px;
      margin: 0 auto 30px;
      background: rgba(30, 41, 59, 0.85);
      padding: 30px;
      border-radius: 16px;
      border: 1px solid rgba(238, 255, 0, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: none;
    }

    .comparison-view.visible {
      display: block;
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .comparison-column {
      background: rgba(15, 23, 42, 0.5);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(238, 255, 0, 0.1);
    }

    .comparison-header {
      font-size: 20px;
      font-weight: 700;
      color: #eeff00;
      margin-bottom: 16px;
      text-align: center;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      background: rgba(71, 85, 105, 0.6);
      border: 1px solid rgba(238, 255, 0, 0.2);
      border-radius: 8px;
      color: #cbd5e1;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: rgba(71, 85, 105, 0.8);
      border-color: rgba(238, 255, 0, 0.4);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #eeff00 0%, #c9d900 100%);
      color: #0f172a;
      border-color: #eeff00;
    }

    .match-item.filter-hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      
      .comparison-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚öΩ MFL Friendly Match Analyzer</h1>
    <p>Analyze team performance across multiple friendly matches</p>
  </div>

  <div class="controls">
    <div class="input-group">
      <input type="text" id="club-id-input" placeholder="Enter Club ID" />
      <input type="number" id="match-limit-input" placeholder="Number of matches (max 10)" value="5" min="1" max="10" />
      <button class="btn btn-primary" id="analyze-btn">üîç Analyze Matches</button>
    </div>
    <div class="input-group">
      <input type="text" id="match-id-input" placeholder="Add individual Match ID" />
      <button class="btn btn-secondary" id="add-match-btn">‚ûï Add Match</button>
      <button class="btn btn-secondary" id="save-analysis-btn" disabled>üíæ Save Analysis</button>
      <button class="btn btn-secondary" id="load-analysis-btn">üìÇ Load Analysis</button>
      <button class="btn btn-secondary" id="compare-btn">üìä Compare Analyses</button>
      <button class="btn btn-export" id="export-btn">üì• Export to CSV</button>
    </div>

    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="all">All Matches</button>
      <button class="filter-btn" data-filter="won">Won</button>
      <button class="filter-btn" data-filter="lost">Lost</button>
      <button class="filter-btn" data-filter="drawn">Drawn</button>
    </div>
  </div>

  <div class="status-container">
    <div class="status" id="status"></div>
  </div>

  <div id="comparison-view" class="comparison-view">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div class="section-title">Analysis Comparison</div>
      <button class="btn btn-secondary" onclick="document.getElementById('comparison-view').classList.remove('visible')">‚úï Close</button>
    </div>
    <div class="comparison-grid" id="comparison-grid"></div>
  </div>

  <div class="overview-section" id="overview-section">
    <div class="section-card">
      <div class="section-title" id="record-title">Match Record</div>
      <div id="match-record"></div>
    </div>

    <div class="section-card">
      <div class="section-title">Your Team (Home) Overview</div>
      <div class="section-subtitle" id="home-overview-subtitle"></div>
      <div class="stats-grid" id="home-stats"></div>
      <div class="xi-summary" id="home-xi-summary"></div>
    </div>

    <div class="section-card">
      <div class="section-title">Opposition (Away) Overview</div>
      <div class="section-subtitle" id="away-overview-subtitle"></div>
      <div class="stats-grid" id="away-stats"></div>
      <div class="xi-summary" id="away-xi-summary"></div>
    </div>

    <div class="section-card">
      <div class="section-title">Player Performance Detail</div>
      <div class="section-subtitle" id="player-detail-subtitle"></div>
      <div style="overflow-x: auto;">
        <table id="player-detail-table">
          <thead>
            <tr>
              <th data-col="name">Player <span class="hide-col-btn" data-hide-col="name">‚úï</span></th>
              <th data-col="position">Pos <span class="hide-col-btn" data-hide-col="position">‚úï</span></th>
              <th data-col="appearances">Apps <span class="hide-col-btn" data-hide-col="appearances">‚úï</span></th>
              <th data-col="rating">Rating <span class="hide-col-btn" data-hide-col="rating">‚úï</span></th>
              <th data-col="goals">G <span class="hide-col-btn" data-hide-col="goals">‚úï</span></th>
              <th data-col="assists">A <span class="hide-col-btn" data-hide-col="assists">‚úï</span></th>
              <th data-col="goalContribution">G+A <span class="hide-col-btn" data-hide-col="goalContribution">‚úï</span></th>
              <th data-col="xG">xG <span class="hide-col-btn" data-hide-col="xG">‚úï</span></th>
              <th data-col="xgDiff">xG¬± <span class="hide-col-btn" data-hide-col="xgDiff">‚úï</span></th>
              <th data-col="conversionRate">Conv% <span class="hide-col-btn" data-hide-col="conversionRate">‚úï</span></th>
              <th data-col="xgPerShot">xG/Shot <span class="hide-col-btn" data-hide-col="xgPerShot">‚úï</span></th>
              <th data-col="shots">Shots <span class="hide-col-btn" data-hide-col="shots">‚úï</span></th>
              <th data-col="shotsOnTarget">SoT <span class="hide-col-btn" data-hide-col="shotsOnTarget">‚úï</span></th>
              <th data-col="shotAccuracy">Shot% <span class="hide-col-btn" data-hide-col="shotAccuracy">‚úï</span></th>
              <th data-col="chancesCreated">Chances <span class="hide-col-btn" data-hide-col="chancesCreated">‚úï</span></th>
              <th data-col="keyPassRate">Key% <span class="hide-col-btn" data-hide-col="keyPassRate">‚úï</span></th>
              <th data-col="passes">Passes <span class="hide-col-btn" data-hide-col="passes">‚úï</span></th>
              <th data-col="passAccuracy">Pass% <span class="hide-col-btn" data-hide-col="passAccuracy">‚úï</span></th>
              <th data-col="crosses">Cross <span class="hide-col-btn" data-hide-col="crosses">‚úï</span></th>
              <th data-col="crossAccuracy">Cross% <span class="hide-col-btn" data-hide-col="crossAccuracy">‚úï</span></th>
              <th data-col="dribbles">Drib <span class="hide-col-btn" data-hide-col="dribbles">‚úï</span></th>
              <th data-col="dribbledPast">Drb Past <span class="hide-col-btn" data-hide-col="dribbledPast">‚úï</span></th>
              <th data-col="defensiveDuelsWonRate">Def% <span class="hide-col-btn" data-hide-col="defensiveDuelsWonRate">‚úï</span></th>
              <th data-col="clearances">Clear <span class="hide-col-btn" data-hide-col="clearances">‚úï</span></th>
              <th data-col="blockedShots">Blocks <span class="hide-col-btn" data-hide-col="blockedShots">‚úï</span></th>
              <th data-col="shotsIntercepted">Sh Int <span class="hide-col-btn" data-hide-col="shotsIntercepted">‚úï</span></th>
              <th data-col="progressivePasses">Prog <span class="hide-col-btn" data-hide-col="progressivePasses">‚úï</span></th>
              <th data-col="fouls">Fouls <span class="hide-col-btn" data-hide-col="fouls">‚úï</span></th>
              <th data-col="foulsSuffered">FS <span class="hide-col-btn" data-hide-col="foulsSuffered">‚úï</span></th>
              <th data-col="yellowCards">YC <span class="hide-col-btn" data-hide-col="yellowCards">‚úï</span></th>
              <th data-col="redCards">RC <span class="hide-col-btn" data-hide-col="redCards">‚úï</span></th>
              <th data-col="ownGoals">OG <span class="hide-col-btn" data-hide-col="ownGoals">‚úï</span></th>
              <th data-col="saves">Saves <span class="hide-col-btn" data-hide-col="saves">‚úï</span></th>
              <th data-col="goalsConceded">GC <span class="hide-col-btn" data-hide-col="goalsConceded">‚úï</span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="player-detail-body"></tbody>
        </table>
      </div>
      <div class="restore-btn-container">
        <button class="btn btn-secondary" id="restore-all-rows-btn">‚Ü∫ Restore All Rows</button>
        <button class="btn btn-secondary" id="restore-all-cols-btn">‚Ü∫ Restore All Columns</button>
      </div>
    </div>
  </div>

  <div class="matches-section" id="matches-section">
    <div class="section-card">
      <div class="section-title" id="matches-title">Match History</div>
      <div id="matches-container"></div>
    </div>
  </div>

  <div class="modal" id="save-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Save Analysis</div>
        <button class="modal-close" onclick="document.getElementById('save-modal').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="input-group" style="margin-bottom: 0;">
          <input type="text" id="analysis-name-input" placeholder="Enter analysis name" />
          <button class="btn btn-primary" id="confirm-save-btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="load-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Load Saved Analysis</div>
        <button class="modal-close" onclick="document.getElementById('load-modal').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body" id="saved-analyses-list"></div>
    </div>
  </div>

  <div class="modal" id="compare-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Select Analyses to Compare</div>
        <button class="modal-close" onclick="document.getElementById('compare-modal').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: #94a3b8;">Select exactly 2 analyses to compare:</p>
        <div id="compare-analyses-list"></div>
        <button class="btn btn-primary" id="confirm-compare-btn" style="margin-top: 20px; width: 100%;">Compare Selected</button>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>MFL Friendly Match Analyzer</p>
  </div>

  <script>
    const API_BASE = "https://z519wdyajg.execute-api.us-east-1.amazonaws.com/prod";
    const POSITION_ORDER = ["GK", "RB", "RWB", "CB", "LB", "LWB", "CDM", "DM", "RM", "LM", "CM", "CAM", "AM", "RW", "LW", "CF", "ST"];

    let allMatches = [];
    let clubId = null;
    let squadId = null;
    let playerDetailSort = { column: "rating", asc: false };
    let playerNamesCache = {};
    let savedAnalyses = [];
    let selectedAnalysesForComparison = [];
    let comparisonHiddenPlayerIds = new Set();
    let comparisonSortState = {
      left: { column: "rating", asc: false },
      right: { column: "rating", asc: false },
    };

    let hiddenPlayerRows = new Set();
    let hiddenPlayerCols = new Set();
    let currentMatchFilter = "all";

    function loadSavedAnalyses() {
      const stored = localStorage.getItem("mfl_saved_analyses");
      if (stored) {
        try {
          savedAnalyses = JSON.parse(stored);
        } catch (e) {
          console.error("Failed to load saved analyses:", e);
          savedAnalyses = [];
        }
      }
    }

    function saveSavedAnalyses() {
      try {
        localStorage.setItem("mfl_saved_analyses", JSON.stringify(savedAnalyses));
      } catch (e) {
        console.error("Failed to save analyses:", e);
      }
    }

    function renderSavedAnalysesList() {
      const list = document.getElementById("saved-analyses-list");
      
      if (savedAnalyses.length === 0) {
        list.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No saved analyses yet</p>';
        return;
      }

      list.innerHTML = savedAnalyses.map(analysis => `
        <div class="saved-analysis-item">
          <div class="saved-analysis-info">
            <div class="saved-analysis-name">${analysis.name}</div>
            <div class="saved-analysis-meta">
              ${analysis.matches.length} matches ‚Ä¢ Saved ${new Date(analysis.timestamp).toLocaleDateString()}
            </div>
          </div>
          <div class="saved-analysis-actions">
            <button class="btn btn-primary" onclick="loadAnalysis(${analysis.id})">Load</button>
            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteAnalysis(${analysis.id})">üóëÔ∏è</button>
          </div>
        </div>
      `).join("");
    }

    function renderCompareAnalysesList() {
      const list = document.getElementById("compare-analyses-list");
      
      if (savedAnalyses.length < 2) {
        list.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">You need at least 2 saved analyses to compare</p>';
        document.getElementById("confirm-compare-btn").disabled = true;
        return;
      }

      list.innerHTML = savedAnalyses.map(analysis => `
        <div class="saved-analysis-item">
          <div class="saved-analysis-info">
            <div class="saved-analysis-name">${analysis.name}</div>
            <div class="saved-analysis-meta">
              ${analysis.matches.length} matches ‚Ä¢ Saved ${new Date(analysis.timestamp).toLocaleDateString()}
            </div>
          </div>
          <input type="checkbox" class="comparison-checkbox" data-analysis-id="${analysis.id}" 
            ${selectedAnalysesForComparison.includes(analysis.id) ? 'checked' : ''} />
        </div>
      `).join("");

      document.querySelectorAll(".comparison-checkbox").forEach(checkbox => {
        checkbox.addEventListener("change", (e) => {
          const id = parseInt(e.target.dataset.analysisId);
          if (e.target.checked) {
            if (selectedAnalysesForComparison.length < 2) {
              selectedAnalysesForComparison.push(id);
            } else {
              e.target.checked = false;
            }
          } else {
            selectedAnalysesForComparison = selectedAnalysesForComparison.filter(x => x !== id);
          }
          document.getElementById("confirm-compare-btn").disabled = selectedAnalysesForComparison.length !== 2;
        });
      });

      document.getElementById("confirm-compare-btn").disabled = selectedAnalysesForComparison.length !== 2;
    }

    function deleteAnalysis(analysisId) {
      if (!confirm("Are you sure you want to delete this saved analysis?")) {
        return;
      }

      savedAnalyses = savedAnalyses.filter(a => a.id !== analysisId);
      saveSavedAnalyses();
      renderSavedAnalysesList();
      renderCompareAnalysesList();
      setStatus("Analysis deleted", "success");
    }

    function loadAnalysis(analysisId) {
      const analysis = savedAnalyses.find(a => a.id === analysisId);
      if (!analysis) {
        setStatus("Analysis not found", "error");
        return;
      }

      allMatches = analysis.matches;
      clubId = analysis.clubId;
      squadId = analysis.squadId;
      
      document.getElementById("load-modal").classList.remove("show");
      document.getElementById("comparison-view").classList.remove("visible");
      
      renderAll();
      setStatus(`Loaded analysis: ${analysis.name}`, "success");
    }

    function setStatus(message, type) {
      const statusEl = document.getElementById("status");
      statusEl.textContent = message;
      statusEl.className = `status ${type} show`;
      
      if (type === "loading") {
        statusEl.innerHTML = `<span class="spinner"></span> ${message}`;
      }

      if (type !== "loading") {
        setTimeout(() => {
          statusEl.classList.remove("show");
        }, 3000);
      }
    }

    function renderMatchRecord() {
      const recordSummary = document.getElementById("match-record");
      recordSummary.innerHTML = "";

      if (allMatches.length === 0) return;

      let won = 0, lost = 0, drawn = 0;

      allMatches.forEach((match) => {
        const home = match.report?.home;
        const away = match.report?.away;
        if (!home || !away) return;

        const homeGoals = home.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;
        const awayGoals = away.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;

        if (homeGoals > awayGoals) won++;
        else if (homeGoals < awayGoals) lost++;
        else drawn++;
      });

      const recordDiv = document.createElement("div");
      recordDiv.style.cssText = "display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;";

      const countsDiv = document.createElement("div");
      countsDiv.style.cssText = "display: flex; gap: 30px; background: rgba(15, 23, 42, 0.5); padding: 20px; border-radius: 10px; border: 1px solid rgba(238, 255, 0, 0.1);";
      countsDiv.innerHTML = `
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: 800; color: #22c55e;">${won}</div>
          <div style="font-size: 14px; color: #94a3b8; margin-top: 4px;">Won</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: 800; color: #94a3b8;">${drawn}</div>
          <div style="font-size: 14px; color: #94a3b8; margin-top: 4px;">Drawn</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: 800; color: #ef4444;">${lost}</div>
          <div style="font-size: 14px; color: #94a3b8; margin-top: 4px;">Lost</div>
        </div>
      `;

      recordDiv.appendChild(countsDiv);
      recordSummary.appendChild(countsDiv);
    }
    async function fetchSquadIdFromClubId(clubId) {
      const url = `${API_BASE}/clubs/${clubId}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch club ${clubId}: ${response.status}`);

      const text = await response.text();
      const pattern = ':[{"id":';
      const index = text.indexOf(pattern);

      if (index === -1) throw new Error("Squad ID not found in club data");

      const afterPattern = text.substring(index + pattern.length);
      const match = afterPattern.match(/^(\d+)/);

      if (!match) throw new Error("Could not parse squad ID");
      return match[1];
    }

    async function fetchMatchIds(squadId, limit) {
  const url = `${API_BASE}/matches?squadId=${squadId}&past=true&limit=${limit}&onlyFriendliesHome=true`;
  const response = await fetch(url);
  if (!response.ok) throw new Error(`Failed to fetch matches: ${response.status}`);

  const data = await response.json();
  // API returns array directly, and uses 'id' not 'matchId'
  return data.map((m) => m.id);
}


    async function fetchMatchReport(matchId) {
      const url = `${API_BASE}/match/report/${matchId}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch match ${matchId}: ${response.status}`);

      const data = await response.json();
      return data;
    }

    async function fetchFormations(matchId) {
      const url = `${API_BASE}/match/${matchId}/formations`;
      const response = await fetch(url);
      if (!response.ok) {
        console.warn(`Failed to fetch formations for match ${matchId}`);
        return null;
      }

      const data = await response.json();
      return data;
    }

    async function fetchPlayerName(playerId) {
      if (playerNamesCache[playerId]) {
        return playerNamesCache[playerId];
      }

      try {
        const url = `${API_BASE}/player/${playerId}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch player ${playerId}`);

        const data = await response.json();
        const name = data.name || `Player ${playerId}`;
        playerNamesCache[playerId] = name;
        return name;
      } catch (e) {
        console.error("Error fetching player name:", e);
        return `Player ${playerId}`;
      }
    }

    function computeXIOverall(formation, playerMap) {
      if (!formation || !formation.positions || formation.positions.length === 0) {
        return null;
      }

      const overalls = formation.positions
        .map((p) => {
          const player = playerMap[p.playerId];
          return player ? player.overall : null;
        })
        .filter((o) => o != null);

      if (overalls.length === 0) return null;

      const min = Math.min(...overalls);
      const max = Math.max(...overalls);
      const avg = (overalls.reduce((a, b) => a + b, 0) / overalls.length).toFixed(1);

      return { min, max, avg };
    }

    async function addMatchById(matchIdInput) {
      if (!matchIdInput || matchIdInput.trim() === "") {
        setStatus("Please enter a match ID", "error");
        return;
      }

      const matchId = matchIdInput.trim();

      if (allMatches.some((m) => m.matchId === matchId)) {
        setStatus(`Match ${matchId} already added`, "error");
        return;
      }

      try {
        setStatus(`Fetching match ${matchId}...`, "loading");

        const report = await fetchMatchReport(matchId);
        const formations = await fetchFormations(matchId);

        allMatches.push({
          matchId,
          report,
          formations,
        });

        renderAll();
        document.getElementById("match-id-input").value = "";
        setStatus(`Successfully added match ${matchId}!`, "success");
      } catch (e) {
        console.error("Error adding match:", e);
        setStatus(`Error: ${e.message}`, "error");
      }
    }

    function deleteMatch(matchId) {
      if (!confirm(`Are you sure you want to delete match ${matchId}?`)) {
        return;
      }

      allMatches = allMatches.filter((m) => m.matchId !== matchId);
      renderAll();
      setStatus(`Deleted match ${matchId}`, "success");
    }

    function calculateTeamStats() {
      if (allMatches.length === 0) return null;

      const homeStats = {
        matches: allMatches.length,
        goals: 0, xG: 0, shots: 0, shotsOnTarget: 0, possession: 0, passes: 0, passAccuracy: 0,
        crosses: 0, crossAccuracy: 0, fouls: 0, yellowCards: 0, redCards: 0, defensiveDuelsWon: 0,
        dribbledPast: 0, shotsBlocked: 0, ownGoals: 0, cleanSheets: 0,
      };

      const awayStats = { ...homeStats };

      let homeXIData = [];
      let awayXIData = [];

      allMatches.forEach((match) => {
        const home = match.report?.home;
        const away = match.report?.away;
        const formations = match.formations;

        if (!home || !away) return;

        const homeGoals = home.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;
        const awayGoals = away.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;

        if (awayGoals === 0) homeStats.cleanSheets++;
        if (homeGoals === 0) awayStats.cleanSheets++;

        if (formations) {
          if (formations.homeFormation && formations.playersMap) {
            const homeXIOverall = computeXIOverall(formations.homeFormation, formations.playersMap);
            if (homeXIOverall) homeXIData.push(homeXIOverall);
          }
          if (formations.awayFormation && formations.playersMap) {
            const awayXIOverall = computeXIOverall(formations.awayFormation, formations.playersMap);
            if (awayXIOverall) awayXIData.push(awayXIOverall);
          }
        }

        function addStats(target, source) {
          if (!source) return;
          target.goals += homeGoals;
          target.xG += source.xG || 0;
          target.shots += source.shots || 0;
          target.shotsOnTarget += source.shotsOnTarget || 0;
          target.possession += source.possession || 0;
          target.passes += source.passes || 0;
          target.passAccuracy += source.passAccuracy || 0;
          target.crosses += source.crosses || 0;
          target.crossAccuracy += source.crossAccuracy || 0;
          target.fouls += source.fouls || 0;
          target.yellowCards += source.yellowCards || 0;
          target.redCards += source.redCards || 0;
          target.defensiveDuelsWon += source.defensiveDuelsWon || 0;
          target.dribbledPast += source.dribbledPast || 0;
          target.shotsBlocked += source.shotsBlocked || 0;
          target.ownGoals += source.ownGoals || 0;
        }

        const homeAgg = home.playersStats?.reduce((acc, p) => {
          acc.xG += p.expectedGoals || 0;
          acc.shots += p.shots || 0;
          acc.shotsOnTarget += p.shotsOnTarget || 0;
          acc.possession += p.possession || 0;
          acc.passes += p.passes || 0;
          acc.passAccuracy += p.passAccuracy || 0;
          acc.crosses += p.crosses || 0;
          acc.crossAccuracy += p.crossAccuracy || 0;
          acc.fouls += p.fouls || 0;
          acc.yellowCards += p.yellowCards || 0;
          acc.redCards += p.redCards || 0;
          acc.defensiveDuelsWon += p.defensiveDuelsWon || 0;
          acc.dribbledPast += p.dribbledPast || 0;
          acc.shotsBlocked += p.shotsBlocked || 0;
          acc.ownGoals += p.ownGoals || 0;
          return acc;
        }, {
          xG: 0, shots: 0, shotsOnTarget: 0, possession: 0, passes: 0, passAccuracy: 0,
          crosses: 0, crossAccuracy: 0, fouls: 0, yellowCards: 0, redCards: 0,
          defensiveDuelsWon: 0, dribbledPast: 0, shotsBlocked: 0, ownGoals: 0,
        }) || {};

        const awayAgg = away.playersStats?.reduce((acc, p) => {
          acc.xG += p.expectedGoals || 0;
          acc.shots += p.shots || 0;
          acc.shotsOnTarget += p.shotsOnTarget || 0;
          acc.possession += p.possession || 0;
          acc.passes += p.passes || 0;
          acc.passAccuracy += p.passAccuracy || 0;
          acc.crosses += p.crosses || 0;
          acc.crossAccuracy += p.crossAccuracy || 0;
          acc.fouls += p.fouls || 0;
          acc.yellowCards += p.yellowCards || 0;
          acc.redCards += p.redCards || 0;
          acc.defensiveDuelsWon += p.defensiveDuelsWon || 0;
          acc.dribbledPast += p.dribbledPast || 0;
          acc.shotsBlocked += p.shotsBlocked || 0;
          acc.ownGoals += p.ownGoals || 0;
          return acc;
        }, {
          xG: 0, shots: 0, shotsOnTarget: 0, possession: 0, passes: 0, passAccuracy: 0,
          crosses: 0, crossAccuracy: 0, fouls: 0, yellowCards: 0, redCards: 0,
          defensiveDuelsWon: 0, dribbledPast: 0, shotsBlocked: 0, ownGoals: 0,
        }) || {};

        homeStats.goals += homeGoals;
        homeStats.xG += homeAgg.xG;
        homeStats.shots += homeAgg.shots;
        homeStats.shotsOnTarget += homeAgg.shotsOnTarget;
        homeStats.possession += homeAgg.possession;
        homeStats.passes += homeAgg.passes;
        homeStats.passAccuracy += homeAgg.passAccuracy;
        homeStats.crosses += homeAgg.crosses;
        homeStats.crossAccuracy += homeAgg.crossAccuracy;
        homeStats.fouls += homeAgg.fouls;
        homeStats.yellowCards += homeAgg.yellowCards;
        homeStats.redCards += homeAgg.redCards;
        homeStats.defensiveDuelsWon += homeAgg.defensiveDuelsWon;
        homeStats.dribbledPast += homeAgg.dribbledPast;
        homeStats.shotsBlocked += homeAgg.shotsBlocked;
        homeStats.ownGoals += homeAgg.ownGoals;

        awayStats.goals += awayGoals;
        awayStats.xG += awayAgg.xG;
        awayStats.shots += awayAgg.shots;
        awayStats.shotsOnTarget += awayAgg.shotsOnTarget;
        awayStats.possession += awayAgg.possession;
        awayStats.passes += awayAgg.passes;
        awayStats.passAccuracy += awayAgg.passAccuracy;
        awayStats.crosses += awayAgg.crosses;
        awayStats.crossAccuracy += awayAgg.crossAccuracy;
        awayStats.fouls += awayAgg.fouls;
        awayStats.yellowCards += awayAgg.yellowCards;
        awayStats.redCards += awayAgg.redCards;
        awayStats.defensiveDuelsWon += awayAgg.defensiveDuelsWon;
        awayStats.dribbledPast += awayAgg.dribbledPast;
        awayStats.shotsBlocked += awayAgg.shotsBlocked;
        awayStats.ownGoals += awayAgg.ownGoals;
      });

      const matches = allMatches.length;

      function avgStat(stat, decimals = 2) {
        return (stat / matches).toFixed(decimals);
      }

      function avgPercentage(stat, decimals = 1) {
        return (stat / matches).toFixed(decimals);
      }

      function calcDefDuelWinRate(won, past) {
        const total = won + past;
        return total > 0 ? ((won / total) * 100).toFixed(1) : "0.0";
      }

      const homeTotalDuels = homeStats.defensiveDuelsWon + homeStats.dribbledPast;
      const awayTotalDuels = awayStats.defensiveDuelsWon + awayStats.dribbledPast;

      const homeFormatted = {
        matches: homeStats.matches,
        goals: avgStat(homeStats.goals),
        xG: avgStat(homeStats.xG),
        shots: avgStat(homeStats.shots),
        shotsOnTarget: avgStat(homeStats.shotsOnTarget),
        shotAccuracy: homeStats.shots > 0 ? ((homeStats.shotsOnTarget / homeStats.shots) * 100).toFixed(1) : "0.0",
        possession: avgPercentage(homeStats.possession),
        passes: avgStat(homeStats.passes, 1),
        passAccuracy: avgPercentage(homeStats.passAccuracy),
        crosses: avgStat(homeStats.crosses, 1),
        crossAccuracy: avgPercentage(homeStats.crossAccuracy),
        fouls: avgStat(homeStats.fouls, 1),
        yellowCards: avgStat(homeStats.yellowCards, 1),
        redCards: avgStat(homeStats.redCards, 2),
        defDuelWinRate: calcDefDuelWinRate(homeStats.defensiveDuelsWon, homeStats.dribbledPast),
        totalDuels: avgStat(homeTotalDuels, 1),
        shotsBlocked: avgStat(homeStats.shotsBlocked, 1),
        ownGoals: avgStat(homeStats.ownGoals, 2),
        cleanSheets: homeStats.cleanSheets,
      };

      const awayFormatted = {
        matches: awayStats.matches,
        goals: avgStat(awayStats.goals),
        xG: avgStat(awayStats.xG),
        shots: avgStat(awayStats.shots),
        shotsOnTarget: avgStat(awayStats.shotsOnTarget),
        shotAccuracy: awayStats.shots > 0 ? ((awayStats.shotsOnTarget / awayStats.shots) * 100).toFixed(1) : "0.0",
        possession: avgPercentage(awayStats.possession),
        passes: avgStat(awayStats.passes, 1),
        passAccuracy: avgPercentage(awayStats.passAccuracy),
        crosses: avgStat(awayStats.crosses, 1),
        crossAccuracy: avgPercentage(awayStats.crossAccuracy),
        fouls: avgStat(awayStats.fouls, 1),
        yellowCards: avgStat(awayStats.yellowCards, 1),
        redCards: avgStat(awayStats.redCards, 2),
        defDuelWinRate: calcDefDuelWinRate(awayStats.defensiveDuelsWon, awayStats.dribbledPast),
        totalDuels: avgStat(awayTotalDuels, 1),
        shotsBlocked: avgStat(awayStats.shotsBlocked, 1),
        ownGoals: avgStat(awayStats.ownGoals, 2),
        cleanSheets: awayStats.cleanSheets,
      };

      if (homeXIData.length > 0) {
        const allMins = homeXIData.map(x => x.min);
        const allMaxs = homeXIData.map(x => x.max);
        const allAvgs = homeXIData.map(x => parseFloat(x.avg));

        homeFormatted.xiOverall = {
          min: Math.min(...allMins),
          max: Math.max(...allMaxs),
          avg: (allAvgs.reduce((a, b) => a + b, 0) / allAvgs.length).toFixed(1),
        };
      }

      if (awayXIData.length > 0) {
        const allMins = awayXIData.map(x => x.min);
        const allMaxs = awayXIData.map(x => x.max);
        const allAvgs = awayXIData.map(x => parseFloat(x.avg));

        awayFormatted.xiOverall = {
          min: Math.min(...allMins),
          max: Math.max(...allMaxs),
          avg: (allAvgs.reduce((a, b) => a + b, 0) / allAvgs.length).toFixed(1),
        };
      }

      return {
        home: homeFormatted,
        away: awayFormatted,
      };
    }

    function calculatePlayerStats() {
      if (allMatches.length === 0) return null;

      const playerAggregates = {};

      allMatches.forEach((match) => {
        const home = match.report?.home;
        if (!home || !home.playersStats) return;

        home.playersStats.forEach((p) => {
          const pid = p.playerId;
          if (!playerAggregates[pid]) {
            playerAggregates[pid] = {
              playerId: pid,
              name: "",
              position: p.position || "?",
              appearances: 0,
              ratingSum: 0,
              goals: 0, assists: 0, xG: 0, shots: 0, shotsOnTarget: 0,
              chancesCreated: 0, keyPasses: 0, passes: 0, passAccuracy: 0,
              crosses: 0, crossAccuracy: 0, dribbles: 0, dribbledPast: 0,
              defensiveDuelsWon: 0, clearances: 0, blockedShots: 0, shotsIntercepted: 0,
              progressivePasses: 0, fouls: 0, foulsSuffered: 0, yellowCards: 0, redCards: 0,
              ownGoals: 0, saves: 0, goalsConceded: 0,
            };
          }

          const agg = playerAggregates[pid];
          agg.appearances++;
          agg.ratingSum += p.rating || 0;
          agg.goals += p.goals || 0;
          agg.assists += p.assists || 0;
          agg.xG += p.expectedGoals || 0;
          agg.shots += p.shots || 0;
          agg.shotsOnTarget += p.shotsOnTarget || 0;
          agg.chancesCreated += p.chancesCreated || 0;
          agg.keyPasses += p.keyPasses || 0;
          agg.passes += p.passes || 0;
          agg.passAccuracy += p.passAccuracy || 0;
          agg.crosses += p.crosses || 0;
          agg.crossAccuracy += p.crossAccuracy || 0;
          agg.dribbles += p.dribbles || 0;
          agg.dribbledPast += p.dribbledPast || 0;
          agg.defensiveDuelsWon += p.defensiveDuelsWon || 0;
          agg.clearances += p.clearances || 0;
          agg.blockedShots += p.blockedShots || 0;
          agg.shotsIntercepted += p.shotsIntercepted || 0;
          agg.progressivePasses += p.progressivePasses || 0;
          agg.fouls += p.fouls || 0;
          agg.foulsSuffered += p.foulsSuffered || 0;
          agg.yellowCards += p.yellowCards || 0;
          agg.redCards += p.redCards || 0;
          agg.ownGoals += p.ownGoals || 0;
          agg.saves += p.saves || 0;
          agg.goalsConceded += p.goalsConceded || 0;
        });
      });

      return playerAggregates;
    }

    function renderHomeOverview() {
      const stats = calculateTeamStats();
      if (!stats) return;

      const container = document.getElementById("home-stats");
      document.getElementById("home-overview-subtitle").textContent = `Averages across ${stats.home.matches} matches`;

      container.innerHTML = `
        <div class="stat-item"><div class="stat-label" title="Goals per match">Goals</div><div class="stat-value">${stats.home.goals}</div></div>
        <div class="stat-item"><div class="stat-label" title="Expected Goals per match">xG</div><div class="stat-value">${stats.home.xG}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shots per match">Shots</div><div class="stat-value">${stats.home.shots}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shots on Target per match">Shots on Target</div><div class="stat-value">${stats.home.shotsOnTarget}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shot Accuracy percentage">Shot Accuracy</div><div class="stat-value">${stats.home.shotAccuracy}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Possession percentage">Possession</div><div class="stat-value">${stats.home.possession}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Passes per match">Passes</div><div class="stat-value">${stats.home.passes}</div></div>
        <div class="stat-item"><div class="stat-label" title="Pass Accuracy percentage">Pass Accuracy</div><div class="stat-value">${stats.home.passAccuracy}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Crosses per match">Crosses</div><div class="stat-value">${stats.home.crosses}</div></div>
        <div class="stat-item"><div class="stat-label" title="Cross Accuracy percentage">Cross Accuracy</div><div class="stat-value">${stats.home.crossAccuracy}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Defensive Duel Win Rate percentage">Def Duel Win %</div><div class="stat-value">${stats.home.defDuelWinRate}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Total Duels per match">Total Duels</div><div class="stat-value">${stats.home.totalDuels}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shots Blocked per match">Shots Blocked</div><div class="stat-value">${stats.home.shotsBlocked}</div></div>
        <div class="stat-item"><div class="stat-label" title="Total Clean Sheets">Clean Sheets</div><div class="stat-value">${stats.home.cleanSheets}</div></div>
        <div class="stat-item"><div class="stat-label" title="Own Goals per match">Own Goals</div><div class="stat-value">${stats.home.ownGoals}</div></div>
        <div class="stat-item"><div class="stat-label" title="Fouls per match">Fouls</div><div class="stat-value">${stats.home.fouls}</div></div>
        <div class="stat-item"><div class="stat-label" title="Yellow Cards per match">Yellow Cards</div><div class="stat-value">${stats.home.yellowCards}</div></div>
        <div class="stat-item"><div class="stat-label" title="Red Cards per match">Red Cards</div><div class="stat-value">${stats.home.redCards}</div></div>
      `;

      const homeXi = stats.home.xiOverall || { min: "-", max: "-", avg: "-" };
      document.getElementById("home-xi-summary").innerHTML = `
        <span><strong>XI Overall Min:</strong> ${homeXi.min}</span>
        <span><strong>XI Overall Max:</strong> ${homeXi.max}</span>
        <span><strong>XI Overall Avg:</strong> ${homeXi.avg}</span>
      `;
    }

    function renderAwayOverview() {
      const stats = calculateTeamStats();
      if (!stats) return;

      const container = document.getElementById("away-stats");
      document.getElementById("away-overview-subtitle").textContent = `Averages across ${stats.away.matches} matches`;

      container.innerHTML = `
        <div class="stat-item"><div class="stat-label" title="Goals per match">Goals</div><div class="stat-value">${stats.away.goals}</div></div>
        <div class="stat-item"><div class="stat-label" title="Expected Goals per match">xG</div><div class="stat-value">${stats.away.xG}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shots per match">Shots</div><div class="stat-value">${stats.away.shots}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shots on Target per match">Shots on Target</div><div class="stat-value">${stats.away.shotsOnTarget}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shot Accuracy percentage">Shot Accuracy</div><div class="stat-value">${stats.away.shotAccuracy}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Possession percentage">Possession</div><div class="stat-value">${stats.away.possession}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Passes per match">Passes</div><div class="stat-value">${stats.away.passes}</div></div>
        <div class="stat-item"><div class="stat-label" title="Pass Accuracy percentage">Pass Accuracy</div><div class="stat-value">${stats.away.passAccuracy}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Crosses per match">Crosses</div><div class="stat-value">${stats.away.crosses}</div></div>
        <div class="stat-item"><div class="stat-label" title="Cross Accuracy percentage">Cross Accuracy</div><div class="stat-value">${stats.away.crossAccuracy}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Defensive Duel Win Rate percentage">Def Duel Win %</div><div class="stat-value">${stats.away.defDuelWinRate}%</div></div>
        <div class="stat-item"><div class="stat-label" title="Total Duels per match">Total Duels</div><div class="stat-value">${stats.away.totalDuels}</div></div>
        <div class="stat-item"><div class="stat-label" title="Shots Blocked per match">Shots Blocked</div><div class="stat-value">${stats.away.shotsBlocked}</div></div>
        <div class="stat-item"><div class="stat-label" title="Total Clean Sheets">Clean Sheets</div><div class="stat-value">${stats.away.cleanSheets}</div></div>
        <div class="stat-item"><div class="stat-label" title="Own Goals per match">Own Goals</div><div class="stat-value">${stats.away.ownGoals}</div></div>
        <div class="stat-item"><div class="stat-label" title="Fouls per match">Fouls</div><div class="stat-value">${stats.away.fouls}</div></div>
        <div class="stat-item"><div class="stat-label" title="Yellow Cards per match">Yellow Cards</div><div class="stat-value">${stats.away.yellowCards}</div></div>
        <div class="stat-item"><div class="stat-label" title="Red Cards per match">Red Cards</div><div class="stat-value">${stats.away.redCards}</div></div>
      `;

      const awayXi = stats.away.xiOverall || { min: "-", max: "-", avg: "-" };
      document.getElementById("away-xi-summary").innerHTML = `
        <span><strong>XI Overall Min:</strong> ${awayXi.min}</span>
        <span><strong>XI Overall Max:</strong> ${awayXi.max}</span>
        <span><strong>XI Overall Avg:</strong> ${awayXi.avg}</span>
      `;
    }

    function aggregateTeamStats(playersStats) {
      if (!playersStats || playersStats.length === 0) return {};

      return playersStats.reduce((acc, p) => {
        acc.xG = (acc.xG || 0) + (p.expectedGoals || 0);
        acc.shots = (acc.shots || 0) + (p.shots || 0);
        acc.shotsOnTarget = (acc.shotsOnTarget || 0) + (p.shotsOnTarget || 0);
        acc.possession = (acc.possession || 0) + (p.possession || 0);
        acc.passes = (acc.passes || 0) + (p.passes || 0);
        acc.passAccuracy = (acc.passAccuracy || 0) + (p.passAccuracy || 0);
        acc.crosses = (acc.crosses || 0) + (p.crosses || 0);
        acc.crossAccuracy = (acc.crossAccuracy || 0) + (p.crossAccuracy || 0);
        acc.fouls = (acc.fouls || 0) + (p.fouls || 0);
        acc.yellowCards = (acc.yellowCards || 0) + (p.yellowCards || 0);
        acc.redCards = (acc.redCards || 0) + (p.redCards || 0);
        return acc;
      }, {});
    }

    function applyHiddenColumns() {
      const table = document.getElementById("player-detail-table");
      const allCols = Array.from(table.querySelectorAll("th[data-col]")).map(th => th.dataset.col);

      allCols.forEach((col) => {
        const th = table.querySelector(`th[data-col="${col}"]`);
        const tds = table.querySelectorAll(`td[data-col="${col}"]`);

        if (hiddenPlayerCols.has(col)) {
          if (th) th.classList.add("hidden-col");
          tds.forEach(td => td.classList.add("hidden-col"));
        } else {
          if (th) th.classList.remove("hidden-col");
          tds.forEach(td => td.classList.remove("hidden-col"));
        }
      });
    }

    function applyMatchFilter() {
      const items = document.querySelectorAll(".match-item");
      
      items.forEach((item) => {
        const result = item.dataset.result;
        
        if (currentMatchFilter === "all") {
          item.classList.remove("filter-hidden");
        } else if (currentMatchFilter === result) {
          item.classList.remove("filter-hidden");
        } else {
          item.classList.add("filter-hidden");
        }
      });
    }

    function sortPlayers(playerAggregates) {
      const players = Object.values(playerAggregates);

      const posOrder = {};
      POSITION_ORDER.forEach((pos, idx) => {
        posOrder[pos] = idx;
      });

      players.sort((a, b) => {
        let valA, valB;

        if (playerDetailSort.column === "name") {
          valA = a.name.toLowerCase();
          valB = b.name.toLowerCase();
          return playerDetailSort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }

        if (playerDetailSort.column === "position") {
          valA = posOrder[a.position] !== undefined ? posOrder[a.position] : 999;
          valB = posOrder[b.position] !== undefined ? posOrder[b.position] : 999;
        } else if (playerDetailSort.column === "rating") {
          valA = a.ratingSum / a.appearances;
          valB = b.ratingSum / b.appearances;
        } else if (playerDetailSort.column === "goalContribution") {
          valA = a.goals + a.assists;
          valB = b.goals + b.assists;
        } else if (playerDetailSort.column === "xgDiff") {
          valA = a.goals - a.xG;
          valB = b.goals - b.xG;
        } else if (playerDetailSort.column === "conversionRate") {
          valA = a.shots > 0 ? (a.goals / a.shots) * 100 : 0;
          valB = b.shots > 0 ? (b.goals / b.shots) * 100 : 0;
        } else if (playerDetailSort.column === "xgPerShot") {
          valA = a.shots > 0 ? a.xG / a.shots : 0;
          valB = b.shots > 0 ? b.xG / b.shots : 0;
        } else if (playerDetailSort.column === "shotAccuracy") {
          valA = a.shots > 0 ? (a.shotsOnTarget / a.shots) * 100 : 0;
          valB = b.shots > 0 ? (b.shotsOnTarget / b.shots) * 100 : 0;
        } else if (playerDetailSort.column === "keyPassRate") {
          valA = a.passes > 0 ? (a.keyPasses / a.passes) * 100 : 0;
          valB = b.passes > 0 ? (b.keyPasses / b.passes) * 100 : 0;
        } else if (playerDetailSort.column === "passAccuracy") {
          valA = a.passAccuracy / a.appearances;
          valB = b.passAccuracy / b.appearances;
        } else if (playerDetailSort.column === "crossAccuracy") {
          valA = a.crossAccuracy / a.appearances;
          valB = b.crossAccuracy / b.appearances;
        } else if (playerDetailSort.column === "defensiveDuelsWonRate") {
          const totalA = a.defensiveDuelsWon + a.dribbledPast;
          const totalB = b.defensiveDuelsWon + b.dribbledPast;
          valA = totalA > 0 ? (a.defensiveDuelsWon / totalA) * 100 : 0;
          valB = totalB > 0 ? (b.defensiveDuelsWon / totalB) * 100 : 0;
        } else {
          valA = a[playerDetailSort.column] || 0;
          valB = b[playerDetailSort.column] || 0;
        }

        if (playerDetailSort.asc) {
          return valA > valB ? 1 : valA < valB ? -1 : 0;
        } else {
          return valA < valB ? 1 : valA > valB ? -1 : 0;
        }
      });

      return players;
    }

    function renderPlayerDetail() {
      const playerAggregates = calculatePlayerStats();
      if (!playerAggregates) return;

      const players = sortPlayers(playerAggregates);

      document.getElementById("player-detail-subtitle").textContent = `${players.length} unique players`;

      const tbody = document.getElementById("player-detail-body");
      tbody.innerHTML = "";

      document.querySelectorAll("#player-detail-table th").forEach((th) => {
        const indicator = th.querySelector(".sort-indicator");
        if (indicator) indicator.remove();
      });

      const currentTh = document.querySelector(`#player-detail-table th[data-col="${playerDetailSort.column}"]`);
      if (currentTh) {
        const indicator = document.createElement("span");
        indicator.className = "sort-indicator";
        indicator.textContent = playerDetailSort.asc ? "‚ñ≤" : "‚ñº";
        currentTh.appendChild(indicator);
      }

      players.forEach((player) => {
        const avgRating = (player.ratingSum / player.appearances).toFixed(2);
        const goalContribution = player.goals + player.assists;
        const xgDiff = (player.goals - player.xG).toFixed(2);
        const conversionRate = player.shots > 0 ? ((player.goals / player.shots) * 100).toFixed(1) : "0";
        const xgPerShot = player.shots > 0 ? (player.xG / player.shots).toFixed(2) : "0.00";
        const shotAcc = player.shots > 0 ? ((player.shotsOnTarget / player.shots) * 100).toFixed(1) : "0";
        const keyPassRate = player.passes > 0 ? ((player.keyPasses / player.passes) * 100).toFixed(1) : "0";
        const avgPassAcc = (player.passAccuracy / player.appearances).toFixed(1);
        const avgCrossAcc = (player.crossAccuracy / player.appearances).toFixed(1);
        const defensiveTotal = player.defensiveDuelsWon + player.dribbledPast;
        const defDuelWinRate = defensiveTotal > 0 ? ((player.defensiveDuelsWon / defensiveTotal) * 100).toFixed(1) : "0";

        if (hiddenPlayerRows.has(player.playerId)) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-col="name">${player.name || `Player ${player.playerId}`}</td>
          <td data-col="position">${player.position}</td>
          <td data-col="appearances">${player.appearances}</td>
          <td data-col="rating">${avgRating}</td>
          <td data-col="goals">${player.goals}</td>
          <td data-col="assists">${player.assists}</td>
          <td data-col="goalContribution">${goalContribution}</td>
          <td data-col="xG">${player.xG.toFixed(2)}</td>
          <td data-col="xgDiff">${xgDiff}</td>
          <td data-col="conversionRate">${conversionRate}</td>
          <td data-col="xgPerShot">${xgPerShot}</td>
          <td data-col="shots">${player.shots}</td>
          <td data-col="shotsOnTarget">${player.shotsOnTarget}</td>
          <td data-col="shotAccuracy">${shotAcc}</td>
          <td data-col="chancesCreated">${player.chancesCreated}</td>
          <td data-col="keyPassRate">${keyPassRate}</td>
          <td data-col="passes">${player.passes}</td>
          <td data-col="passAccuracy">${avgPassAcc}</td>
          <td data-col="crosses">${player.crosses}</td>
          <td data-col="crossAccuracy">${avgCrossAcc}</td>
          <td data-col="dribbles">${player.dribbles}</td>
          <td data-col="dribbledPast">${player.dribbledPast}</td>
          <td data-col="defensiveDuelsWonRate">${defDuelWinRate}</td>
          <td data-col="clearances">${player.clearances}</td>
          <td data-col="blockedShots">${player.blockedShots}</td>
          <td data-col="shotsIntercepted">${player.shotsIntercepted}</td>
          <td data-col="progressivePasses">${player.progressivePasses}</td>
          <td data-col="fouls">${player.fouls}</td>
          <td data-col="foulsSuffered">${player.foulsSuffered}</td>
          <td data-col="yellowCards">${player.yellowCards}</td>
          <td data-col="redCards">${player.redCards}</td>
          <td data-col="ownGoals">${player.ownGoals}</td>
          <td data-col="saves">${player.saves}</td>
          <td data-col="goalsConceded">${player.goalsConceded}</td>
          <td><button class="hide-row-btn" data-player-id="${player.playerId}">Hide</button></td>
        `;

        tbody.appendChild(tr);
      });

      applyHiddenColumns();

      document.querySelectorAll(".hide-row-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const playerId = btn.dataset.playerId;
          hiddenPlayerRows.add(playerId);
          renderPlayerDetail();
        });
      });
    }

    function renderMatches() {
      const container = document.getElementById("matches-container");

      if (allMatches.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; padding: 20px;">No matches loaded</p>';
        return;
      }

      document.getElementById("matches-title").textContent = `Match History (${allMatches.length} matches)`;

      container.innerHTML = "";

      allMatches.forEach((match) => {
        const home = match.report?.home;
        const away = match.report?.away;
        const formations = match.formations;

        if (!home || !away) return;

        const homeGoals = home.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;
        const awayGoals = away.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;

        const homeStats = aggregateTeamStats(home.playersStats);
        const awayStats = aggregateTeamStats(away.playersStats);

        let homeFormationType = "-";
        let awayFormationType = "-";
        let homeXIOverall = 0;
        let awayXIOverall = 0;
        let homeName = "Home Team";
        let awayName = "Away Team";

        if (formations) {
          if (formations.homeFormation) {
            homeFormationType = formations.homeFormation.type || "-";
            if (formations.playersMap) {
              const homeXI = computeXIOverall(formations.homeFormation, formations.playersMap);
              if (homeXI) {
                homeXIOverall = homeXI.avg;
              }
            }
            if (formations.homeClub) {
              homeName = formations.homeClub.name || "Home Team";
            }
          }

          if (formations.awayFormation) {
            awayFormationType = formations.awayFormation.type || "-";
            if (formations.playersMap) {
              const awayXI = computeXIOverall(formations.awayFormation, formations.playersMap);
              if (awayXI) {
                awayXIOverall = awayXI.avg;
              }
            }
            if (formations.awayClub) {
              awayName = formations.awayClub.name || "Away Team";
            }
          }
        }

        const matchDate = match.report.createdAt ? new Date(match.report.createdAt).toLocaleDateString() : "Unknown";

        let matchResult = "drawn";
        if (homeGoals > awayGoals) matchResult = "won";
        else if (homeGoals < awayGoals) matchResult = "lost";

        const matchItem = document.createElement("div");
        matchItem.className = "match-item";
        matchItem.dataset.result = matchResult;

        matchItem.innerHTML = `
          <div class="match-header">
            <div>
              <div class="match-title">Match ID: ${match.matchId}</div>
              <div class="match-date">${matchDate}</div>
            </div>
            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteMatch(${match.matchId})">üóëÔ∏è Delete</button>
          </div>

          <div class="match-score">
            <div class="team-name" style="text-align: right;">${homeName}</div>
            <div class="score">${homeGoals}</div>
            <div style="color: #64748b;">-</div>
            <div class="score">${awayGoals}</div>
            <div class="team-name">${awayName}</div>
          </div>

          <div class="match-stats">
            <div class="team-stats">
              <div class="stat-row"><span class="label">Formation:</span> <span>${homeFormationType}</span></div>
              <div class="stat-row"><span class="label">XI Overall:</span> <span>${homeXIOverall || "-"}</span></div>
              <div class="stat-row"><span class="label">xG:</span> <span>${(homeStats.xG || 0).toFixed(2)}</span></div>
              <div class="stat-row"><span class="label">Shots:</span> <span>${homeStats.shots || 0}</span></div>
              <div class="stat-row"><span class="label">Shots on Target:</span> <span>${homeStats.shotsOnTarget || 0}</span></div>
              <div class="stat-row"><span class="label">Possession:</span> <span>${(homeStats.possession || 0).toFixed(1)}%</span></div>
              <div class="stat-row"><span class="label">Passes:</span> <span>${homeStats.passes || 0}</span></div>
              <div class="stat-row"><span class="label">Pass Accuracy:</span> <span>${(homeStats.passAccuracy || 0).toFixed(1)}%</span></div>
            </div>

            <div class="stat-divider"></div>

            <div class="team-stats" style="align-items: flex-end;">
              <div class="stat-row"><span>${awayFormationType}</span> <span class="label">:Formation</span></div>
              <div class="stat-row"><span>${awayXIOverall || "-"}</span> <span class="label">:XI Overall</span></div>
              <div class="stat-row"><span>${(awayStats.xG || 0).toFixed(2)}</span> <span class="label">:xG</span></div>
              <div class="stat-row"><span>${awayStats.shots || 0}</span> <span class="label">:Shots</span></div>
              <div class="stat-row"><span>${awayStats.shotsOnTarget || 0}</span> <span class="label">:Shots on Target</span></div>
              <div class="stat-row"><span>${(awayStats.possession || 0).toFixed(1)}%</span> <span class="label">:Possession</span></div>
              <div class="stat-row"><span>${awayStats.passes || 0}</span> <span class="label">:Passes</span></div>
              <div class="stat-row"><span>${(awayStats.passAccuracy || 0).toFixed(1)}%</span> <span class="label">:Pass Accuracy</span></div>
            </div>
          </div>
        `;

        container.appendChild(matchItem);
      });

      applyMatchFilter();
    }

    async function analyzeMatches() {
      const clubIdInput = document.getElementById("club-id-input").value.trim();
      const limitInput = parseInt(document.getElementById("match-limit-input").value) || 5;

      if (!clubIdInput) {
        setStatus("Please enter a Club ID", "error");
        return;
      }

      clubId = clubIdInput;
      const limit = Math.min(Math.max(limitInput, 1), 10);

      try {
        setStatus("Fetching squad ID...", "loading");
        squadId = await fetchSquadIdFromClubId(clubId);

        setStatus(`Fetching last ${limit} friendly matches...`, "loading");
        const matchIds = await fetchMatchIds(squadId, limit);

        if (matchIds.length === 0) {
          setStatus("No friendly matches found", "error");
          return;
        }

        setStatus(`Loading ${matchIds.length} matches...`, "loading");

        allMatches = [];

        for (let i = 0; i < matchIds.length; i++) {
          const matchId = matchIds[i];
          setStatus(`Loading match ${i + 1}/${matchIds.length}...`, "loading");

          const report = await fetchMatchReport(matchId);
          const formations = await fetchFormations(matchId);

          allMatches.push({
            matchId,
            report,
            formations,
          });
        }

        setStatus("Fetching player names...", "loading");
        const playerIds = new Set();
        allMatches.forEach((match) => {
          const home = match.report?.home;
          if (home && home.playersStats) {
            home.playersStats.forEach((p) => playerIds.add(p.playerId));
          }
        });

        const playerIdsArray = Array.from(playerIds);
        for (let i = 0; i < playerIdsArray.length; i++) {
          await fetchPlayerName(playerIdsArray[i]);
        }

        const playerAggregates = calculatePlayerStats();
        if (playerAggregates) {
          for (const pid in playerAggregates) {
            const player = playerAggregates[pid];
            if (!player.name) {
              player.name = playerNamesCache[pid] || `Player ${pid}`;
            }
          }
        }

        renderAll();
        setStatus(`Successfully loaded ${allMatches.length} matches!`, "success");
      } catch (e) {
        console.error("Error analyzing matches:", e);
        setStatus(`Error: ${e.message}`, "error");
      }
    }

    function exportToCSV() {
      if (allMatches.length === 0) {
        setStatus("No data to export", "error");
        return;
      }

      const playerAggregates = calculatePlayerStats();
      if (!playerAggregates) {
        setStatus("No player data to export", "error");
        return;
      }

      const players = sortPlayers(playerAggregates);

      const headers = [
        "Player", "Position", "Apps", "Rating", "Goals", "Assists", "G+A", "xG", "xG¬±", "Conv%", "xG/Shot",
        "Shots", "SoT", "Shot%", "Chances", "Key%", "Passes", "Pass%", "Crosses", "Cross%",
        "Dribbles", "Drib Past", "Def%", "Clearances", "Blocked Shots", "Shots Int", "Prog Passes",
        "Fouls", "Fouls Suffered", "YC", "RC", "OG", "Saves", "GC"
      ];

      const rows = players.map((player) => {
        const avgRating = (player.ratingSum / player.appearances).toFixed(2);
        const goalContribution = player.goals + player.assists;
        const xgDiff = (player.goals - player.xG).toFixed(2);
        const conversionRate = player.shots > 0 ? ((player.goals / player.shots) * 100).toFixed(1) : "0";
        const xgPerShot = player.shots > 0 ? (player.xG / player.shots).toFixed(2) : "0.00";
        const shotAcc = player.shots > 0 ? ((player.shotsOnTarget / player.shots) * 100).toFixed(1) : "0";
        const keyPassRate = player.passes > 0 ? ((player.keyPasses / player.passes) * 100).toFixed(1) : "0";
        const avgPassAcc = (player.passAccuracy / player.appearances).toFixed(1);
        const avgCrossAcc = (player.crossAccuracy / player.appearances).toFixed(1);
        const defensiveTotal = player.defensiveDuelsWon + player.dribbledPast;
        const defDuelWinRate = defensiveTotal > 0 ? ((player.defensiveDuelsWon / defensiveTotal) * 100).toFixed(1) : "0";

        return [
          player.name || `Player ${player.playerId}`,
          player.position,
          player.appearances,
          avgRating,
          player.goals,
          player.assists,
          goalContribution,
          player.xG.toFixed(2),
          xgDiff,
          conversionRate,
          xgPerShot,
          player.shots,
          player.shotsOnTarget,
          shotAcc,
          player.chancesCreated,
          keyPassRate,
          player.passes,
          avgPassAcc,
          player.crosses,
          avgCrossAcc,
          player.dribbles,
          player.dribbledPast,
          defDuelWinRate,
          player.clearances,
          player.blockedShots,
          player.shotsIntercepted,
          player.progressivePasses,
          player.fouls,
          player.foulsSuffered,
          player.yellowCards,
          player.redCards,
          player.ownGoals,
          player.saves,
          player.goalsConceded
        ];
      });

      const csvContent = [
        headers.join(","),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(","))
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `mfl_friendly_analysis_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      setStatus("CSV exported successfully!", "success");
    }

    function renderAll() {
      if (allMatches.length > 0) {
        document.getElementById("overview-section").classList.add("visible");
        document.getElementById("matches-section").classList.add("visible");
        document.getElementById("save-analysis-btn").disabled = false;
        renderMatchRecord();
        renderHomeOverview();
        renderAwayOverview();
        renderPlayerDetail();
        renderMatches();
      } else {
        document.getElementById("overview-section").classList.remove("visible");
        document.getElementById("matches-section").classList.remove("visible");
        document.getElementById("save-analysis-btn").disabled = true;
      }
    }

    function renderComparisonView(leftAnalysis, rightAnalysis) {
      const comparisonGrid = document.getElementById("comparison-grid");
      comparisonGrid.innerHTML = "";

      function createComparisonColumn(analysis, side) {
        const playerAggregates = {};

        analysis.matches.forEach((match) => {
          const home = match.report?.home;
          if (!home || !home.playersStats) return;

          home.playersStats.forEach((p) => {
            const pid = p.playerId;
            if (!playerAggregates[pid]) {
              playerAggregates[pid] = {
                playerId: pid,
                name: "",
                position: p.position || "?",
                appearances: 0,
                ratingSum: 0,
                goals: 0, assists: 0, xG: 0, shots: 0, shotsOnTarget: 0,
                chancesCreated: 0, keyPasses: 0, passes: 0, passAccuracy: 0,
                crosses: 0, crossAccuracy: 0, dribbles: 0, dribbledPast: 0,
                defensiveDuelsWon: 0, clearances: 0, blockedShots: 0, shotsIntercepted: 0,
                progressivePasses: 0, fouls: 0, foulsSuffered: 0, yellowCards: 0, redCards: 0,
                ownGoals: 0, saves: 0, goalsConceded: 0,
              };
            }

            const agg = playerAggregates[pid];
            agg.appearances++;
            agg.ratingSum += p.rating || 0;
            agg.goals += p.goals || 0;
            agg.assists += p.assists || 0;
            agg.xG += p.expectedGoals || 0;
            agg.shots += p.shots || 0;
            agg.shotsOnTarget += p.shotsOnTarget || 0;
            agg.chancesCreated += p.chancesCreated || 0;
            agg.keyPasses += p.keyPasses || 0;
            agg.passes += p.passes || 0;
            agg.passAccuracy += p.passAccuracy || 0;
            agg.crosses += p.crosses || 0;
            agg.crossAccuracy += p.crossAccuracy || 0;
            agg.dribbles += p.dribbles || 0;
            agg.dribbledPast += p.dribbledPast || 0;
            agg.defensiveDuelsWon += p.defensiveDuelsWon || 0;
            agg.clearances += p.clearances || 0;
            agg.blockedShots += p.blockedShots || 0;
            agg.shotsIntercepted += p.shotsIntercepted || 0;
            agg.progressivePasses += p.progressivePasses || 0;
            agg.fouls += p.fouls || 0;
            agg.foulsSuffered += p.foulsSuffered || 0;
            agg.yellowCards += p.yellowCards || 0;
            agg.redCards += p.redCards || 0;
            agg.ownGoals += p.ownGoals || 0;
            agg.saves += p.saves || 0;
            agg.goalsConceded += p.goalsConceded || 0;
          });
        });

        for (const pid in playerAggregates) {
          const player = playerAggregates[pid];
          if (!player.name) {
            player.name = playerNamesCache[pid] || `Player ${pid}`;
          }
        }

        const posOrder = {};
        POSITION_ORDER.forEach((pos, idx) => {
          posOrder[pos] = idx;
        });

        const players = Object.values(playerAggregates);
        const sortState = comparisonSortState[side];

        players.sort((a, b) => {
          let valA, valB;

          if (sortState.column === "name") {
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return sortState.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
          }

          if (sortState.column === "position") {
            valA = posOrder[a.position] !== undefined ? posOrder[a.position] : 999;
            valB = posOrder[b.position] !== undefined ? posOrder[b.position] : 999;
          } else if (sortState.column === "rating") {
            valA = a.ratingSum / a.appearances;
            valB = b.ratingSum / b.appearances;
          } else if (sortState.column === "goalContribution") {
            valA = a.goals + a.assists;
            valB = b.goals + b.assists;
          } else if (sortState.column === "xgDiff") {
            valA = a.goals - a.xG;
            valB = b.goals - b.xG;
          } else if (sortState.column === "conversionRate") {
            valA = a.shots > 0 ? (a.goals / a.shots) * 100 : 0;
            valB = b.shots > 0 ? (b.goals / b.shots) * 100 : 0;
          } else {
            valA = a[sortState.column] || 0;
            valB = b[sortState.column] || 0;
          }

          if (sortState.asc) {
            return valA > valB ? 1 : valA < valB ? -1 : 0;
          } else {
            return valA < valB ? 1 : valA > valB ? -1 : 0;
          }
        });

        const columnDiv = document.createElement("div");
        columnDiv.className = "comparison-column";

        const header = document.createElement("div");
        header.className = "comparison-header";
        header.textContent = analysis.name;
        columnDiv.appendChild(header);

        const subtitle = document.createElement("div");
        subtitle.style.cssText = "text-align: center; color: #94a3b8; font-size: 14px; margin-bottom: 16px;";
        subtitle.textContent = `${players.length} players ‚Ä¢ ${analysis.matches.length} matches`;
        columnDiv.appendChild(subtitle);

        const tableWrapper = document.createElement("div");
        tableWrapper.style.overflowX = "auto";

        const table = document.createElement("table");
        table.style.fontSize = "13px";

        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        const columns = [
          { key: "name", label: "Player" },
          { key: "position", label: "Pos" },
          { key: "appearances", label: "Apps" },
          { key: "rating", label: "Rating" },
          { key: "goals", label: "G" },
          { key: "assists", label: "A" },
          { key: "goalContribution", label: "G+A" },
        ];

        columns.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = col.label;
          th.style.cursor = "pointer";
          th.dataset.col = col.key;

          if (sortState.column === col.key) {
            const indicator = document.createElement("span");
            indicator.className = "sort-indicator";
            indicator.textContent = sortState.asc ? "‚ñ≤" : "‚ñº";
            th.appendChild(indicator);
          }

          th.addEventListener("click", () => {
            if (sortState.column === col.key) {
              sortState.asc = !sortState.asc;
            } else {
              sortState.column = col.key;
              sortState.asc = false;
            }
            renderComparisonView(leftAnalysis, rightAnalysis);
          });

          headerRow.appendChild(th);
        });

        const actionTh = document.createElement("th");
        actionTh.textContent = "Actions";
        headerRow.appendChild(actionTh);

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        players.forEach((player) => {
          if (comparisonHiddenPlayerIds.has(player.playerId)) return;

          const avgRating = (player.ratingSum / player.appearances).toFixed(2);
          const goalContribution = player.goals + player.assists;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${player.name}</td>
            <td>${player.position}</td>
            <td>${player.appearances}</td>
            <td>${avgRating}</td>
            <td>${player.goals}</td>
            <td>${player.assists}</td>
            <td>${goalContribution}</td>
            <td><button class="hide-row-btn comparison-hide-btn" data-player-id="${player.playerId}">Hide</button></td>
          `;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        columnDiv.appendChild(tableWrapper);

        return columnDiv;
      }

      const leftColumn = createComparisonColumn(leftAnalysis, "left");
      const rightColumn = createComparisonColumn(rightAnalysis, "right");

      comparisonGrid.appendChild(leftColumn);
      comparisonGrid.appendChild(rightColumn);

      document.querySelectorAll(".comparison-hide-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const playerId = btn.dataset.playerId;
          comparisonHiddenPlayerIds.add(playerId);
          renderComparisonView(leftAnalysis, rightAnalysis);
        });
      });
    }

    // Event listeners
    document.getElementById("analyze-btn").addEventListener("click", analyzeMatches);

    document.getElementById("add-match-btn").addEventListener("click", () => {
      const matchIdInput = document.getElementById("match-id-input").value;
      addMatchById(matchIdInput);
    });

    document.getElementById("match-id-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        const matchIdInput = document.getElementById("match-id-input").value;
        addMatchById(matchIdInput);
      }
    });

    document.getElementById("save-analysis-btn").addEventListener("click", () => {
      if (allMatches.length === 0) {
        setStatus("No matches to save", "error");
        return;
      }
      document.getElementById("save-modal").classList.add("show");
      document.getElementById("analysis-name-input").value = "";
      document.getElementById("analysis-name-input").focus();
    });

    document.getElementById("confirm-save-btn").addEventListener("click", () => {
      const name = document.getElementById("analysis-name-input").value.trim();
      if (!name) {
        setStatus("Please enter a name for the analysis", "error");
        return;
      }

      const analysis = {
        id: Date.now(),
        name,
        timestamp: Date.now(),
        clubId,
        squadId,
        matches: allMatches,
      };

      savedAnalyses.push(analysis);
      saveSavedAnalyses();
      
      document.getElementById("save-modal").classList.remove("show");
      setStatus(`Analysis saved as "${name}"`, "success");
    });

    document.getElementById("analysis-name-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        document.getElementById("confirm-save-btn").click();
      }
    });

    document.getElementById("load-analysis-btn").addEventListener("click", () => {
      renderSavedAnalysesList();
      document.getElementById("load-modal").classList.add("show");
    });

    document.getElementById("compare-btn").addEventListener("click", () => {
      selectedAnalysesForComparison = [];
      renderCompareAnalysesList();
      document.getElementById("compare-modal").classList.add("show");
    });

    document.getElementById("confirm-compare-btn").addEventListener("click", () => {
      if (selectedAnalysesForComparison.length !== 2) {
        setStatus("Please select exactly 2 analyses to compare", "error");
        return;
      }

      const leftAnalysis = savedAnalyses.find(a => a.id === selectedAnalysesForComparison[0]);
      const rightAnalysis = savedAnalyses.find(a => a.id === selectedAnalysesForComparison[1]);

      if (!leftAnalysis || !rightAnalysis) {
        setStatus("Error loading analyses for comparison", "error");
        return;
      }

      comparisonHiddenPlayerIds.clear();
      comparisonSortState = {
        left: { column: "rating", asc: false },
        right: { column: "rating", asc: false },
      };

      renderComparisonView(leftAnalysis, rightAnalysis);
      
      document.getElementById("compare-modal").classList.remove("show");
      document.getElementById("comparison-view").classList.add("visible");
    });

    document.getElementById("export-btn").addEventListener("click", exportToCSV);

    // Player detail table sorting
    document.querySelectorAll("#player-detail-table th[data-col]").forEach((th) => {
      th.addEventListener("click", (e) => {
        if (e.target.classList.contains("hide-col-btn")) return;
        
        const col = th.getAttribute("data-col");
        if (playerDetailSort.column === col) {
          playerDetailSort.asc = !playerDetailSort.asc;
        } else {
          playerDetailSort.column = col;
          playerDetailSort.asc = false;
        }
        renderPlayerDetail();
      });
    });

    // Hide column buttons
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("hide-col-btn")) {
        e.stopPropagation();
        const col = e.target.dataset.hideCol;
        hiddenPlayerCols.add(col);
        applyHiddenColumns();
      }
    });

    // Restore all rows button
    document.getElementById("restore-all-rows-btn").addEventListener("click", () => {
      hiddenPlayerRows.clear();
      renderPlayerDetail();
    });

    // Restore all columns button
    document.getElementById("restore-all-cols-btn").addEventListener("click", () => {
      hiddenPlayerCols.clear();
      applyHiddenColumns();
    });

    // Match filter buttons
    document.querySelectorAll(".filter-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentMatchFilter = btn.dataset.filter;
        applyMatchFilter();
      });
    });

    loadSavedAnalyses();
  });
  </script>
</body>
</html>
